<analysis>
The trajectory documents a multi-sprint, highly iterative development cycle on a complex financial accounting (FIBU) application. The work was driven by continuous, detailed user feedback in German.

The initial phase focused on UI/UX enhancements and feature implementation, including creating a custom date-range picker, enabling URL-based filtering, and building new views for purchase invoices () and creditor assignment ().

A significant portion of the work involved critical bug fixing and performance optimization. This included resolving a major API performance bottleneck by implementing server-side caching on two key endpoints ( and ), which reduced load times from over 15 seconds to under 3.

Data integrity was a recurring and central theme. The engineer repeatedly addressed issues of incorrect or corrupt data. Key tasks included:
1.  **Creditor Data Correction:** A critical bug where an imported CSV of creditors was not correctly reflected in the UI was traced back to multiple MongoDB collections (, ) and an incorrect database name in the import script's environment. This was resolved by consolidating to a single source of truth and correcting the script.
2.  **Purchase Invoice Cleanup:** False purchase invoices (e.g., the company's own name, sales invoices) were filtered out. Duplicate entries were programmatically identified and removed.
3.  **Payment Assignment Logic:** A major flaw was fixed where Amazon Payment transactions were incorrectly assigned to internal sales invoices () by the fuzzy-matching logic. The engineer corrected this by adding a specific rule to only match them to external () invoices and created a script to clean up 221 historical incorrect assignments.

The final user request, after all functional requirements were met, was to prepare the project for a fork by creating comprehensive documentation.
</analysis>

<product_requirements>
The objective is to build a comprehensive in-house accounting (FIBU) module to centralize and automate financial operations, integrating with an existing JTL (MSSQL) database and a new MongoDB for enhanced data.

**Core Features Implemented:**
1.  **Unified FIBU Dashboard:** A central view () with tab navigation for an Overview (KPIs), Sales Invoices, Purchase Invoices, Payments, and Creditor Assignment.
2.  **Advanced Data Views:**
    *   **Purchase Invoices ():** A filterable, sortable table of verified purchase invoices. Features include a document viewer (fetching Base64 PDFs), the ability to move invoices back to assignment, and a delete function.
    *   **Creditor Assignment ():** A workspace to manage unassigned invoices. Implemented features include a document viewer, an invoice-editing modal, and an intelligent assignment system that maps all open invoices from the same supplier upon a single assignment.
    *   **Creditor Management:** A full CRUD interface for managing creditors, including bulk import from CSV.
3.  **Data Integrity and Automation:**
    *   Systematic filtering to remove erroneous data (e.g., self-company as supplier, sales invoices listed as purchases).
    *   Programmatic removal of duplicate purchase invoices.
    *   Corrected payment assignment logic to ensure Amazon payments only map to Amazon's external invoices ().
    *   Server-side caching to ensure fast UI load times.
</product_requirements>

<key_technical_concepts>
- **Hybrid Database Architecture:** Integrates a JTL MSSQL database for core business data and a MongoDB ( database) for new, enriched accounting data like parsed invoices, creditor mappings, and processed payments.
- **Server-Side Caching:** Implemented on performance-critical API routes (, ) to store results in memory for a set duration, drastically reducing database load and improving UI responsiveness.
- **Data Ingestion and Parsing:** Processes incoming purchase invoices from emails, storing PDF attachments as Base64 strings in the  collection. Handles CSV imports for creditor data.
- **Rule-Based and Batch Data Processing:** Employs scripts and API logic for data correction, such as removing incorrect payment assignments and a smart-assignment feature that updates all related invoices in a batch.
</key_technical_concepts>

<code_architecture>
The application is a Next.js full-stack SPA. The frontend is built with React and shadcn/ui. The backend consists of API routes under  that connect to both a MongoDB database and a JTL MSSQL database. Node.js scripts are used for batch operations like data imports.

**Directory Structure:**


**Key File Analysis:**

-   ****
    -   **Importance:** This API aggregates all data for the main FIBU dashboard. It was a major performance bottleneck.
    -   **Changes:** Refactored to eliminate chained internal  calls. A server-side caching layer was added to store the entire summary object for 5 minutes, reducing load times from ~15s to ~3s on subsequent loads. It was also corrected to calculate  properly and include all necessary data () in the response.

-   ****
    -   **Importance:** The main UI for assigning creditors to unassigned purchase invoices. It's a critical workflow component.
    -   **Changes:** Massively overhauled. It now features an intelligent assignment where assigning one invoice from a supplier assigns all others. An Aktionen column was added with buttons to view the PDF beleg () and open an edit modal (). The layout was fixed to prevent the assignment dropdown from being cut off.

-   ****
    -   **Importance:** Provides the data for the verified Purchase Invoices view. Contains crucial business logic for data purity.
    -   **Changes:** Created from scratch. It filters out invoices with a  of 0 or no assigned , effectively separating unprocessed from verified invoices. It also contains logic to filter out incorrect entries (like the company's own name) and a de-duplication step based on a composite key ().

-   ****
    -   **Importance:** Script for the one-time bulk import of creditor data from a user-provided CSV.
    -   **Changes:** This script was the subject of a major debugging effort. It was corrected to handle file encoding, connect to the correct MongoDB database ( instead of ), write to the correct collection (), and—most importantly—to delete all existing creditors before import to ensure the CSV is the single source of truth.

-   ****
    -   **Importance:** A one-time-use API created to fix a critical data corruption issue.
    -   **Changes:** Created to identify and remove all incorrect associations where an Amazon Payment was linked to a non-Amazon () invoice. It successfully removed 221 incorrect links.

-   ****
    -   **Importance:** Documents how invoice documents (Belege) are processed and stored.
    -   **Changes:** Created to explain that invoices arrive via email, and the system stores their PDF attachments as Base64 strings in the  collection, linking them via .
</code_architecture>

<pending_tasks>
- **Create Project Documentation:** The primary pending task is to create and update all necessary documentation files (, , etc.) to prepare the project for a fork, as explicitly requested by the user.
</pending_tasks>

<current_work>
The most recent work cycle focused on fixing a critical data integrity issue where Amazon Payment transactions were being incorrectly assigned to internal sales invoices () instead of Amazon's external invoices ().

The user correctly identified that this was wrong and that Amazon sales should only have one external invoice. The AI engineer diagnosed the problem, pinpointing the cause to the generic fuzzy-matching logic in , which was matching based on amount without considering the payment provider.

**The following actions were taken to resolve this:**

1.  **Logic Correction:** The SQL query in the main payments API () was updated with a  on  to correctly link Amazon payments directly to their corresponding external invoices within the JTL database. This ensures future assignments are correct.

2.  **Historical Data Cleanup:** A one-time API endpoint, , was created and executed. This API searched the MongoDB  collection for any Amazon Payment incorrectly linked to a  starting with RE- and removed the link. The execution confirmed that **221 incorrect assignments were successfully removed**.

Immediately after confirming this fix, the user made the final request of the trajectory: **Wir müssen Forken bitte dokus in die txt dateien** (We need to fork, please create the docs in the txt files). The AI engineer's last action was acknowledging this and preparing to start the documentation process.
</current_work>

<optional_next_step>
Create and update all necessary documentation files (, , , etc.) in the  and root directories to prepare the project for the requested fork.
</optional_next_step>

<verbatim_quotes>
- **User's Last Request:** Wir müssen Forken bitte dokus in die txt dateien
- **AI Engineer's Last Response:** Verstanden! Ich aktualisiere jetzt alle Dokumentationen für das Forken. Ich erstelle/aktualisiere die wichtigsten TXT/MD Dateien
</verbatim_quotes>
