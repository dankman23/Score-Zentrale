<analysis>
The trajectory documents the development of a comprehensive accounting (FIBU) module for the Score Zentrale application. The work commenced with building a Kontenplan (Chart of Accounts) management system, including CRUD APIs and an Excel import feature, with data stored in MongoDB. A key architectural decision was implementing server-side pagination to resolve frontend performance issues when loading large datasets.

The next phase involved integrating with an external JTL MS SQL database to fetch sales invoices (VK) and payments. This was a challenging, iterative process marked by extensive SQL debugging to correctly identify table and column names within the JTL schema.

Subsequently, the module was enhanced with AI capabilities by integrating Google Gemini to parse uploaded supplier invoice (EK) PDFs. Following this, the core objective of creating a data export compatible with 10it accounting software was successfully completed.

Further development, driven by user feedback, included importing a list of creditors (Kreditoren) from a CSV for automatic matching against supplier invoices, and building a fully automated email inbox poller using IMAP to ingest invoices sent as attachments.

The trajectory concludes with the engineer addressing critical data discrepancy issues reported by the user, specifically concerning incorrect payment-to-invoice association and missing transaction data from certain providers.
</analysis>

<product_requirements>
The primary objective is to build a comprehensive FIBU (Accounting) module to automate and streamline bookkeeping tasks for the Score Zentrale application.

**Core Features Implemented:**
1.  **Chart of Accounts (Kontenplan):** A complete CRUD system for managing accounts, including import from Excel, stored in MongoDB.
2.  **JTL Data Integration:** Fetching sales invoices (VK-Rechnungen) and all payment records (Zahlungen) from an external JTL MS SQL database.
3.  **AI-Powered Supplier Invoice Processing (EK-Rechnungen):** A feature to upload supplier invoices as PDFs, which are automatically parsed by Google Gemini to extract key data.
4.  **Creditor Management:** Import of creditors via CSV and an intelligent matching system to automatically associate uploaded supplier invoices with the correct creditor.
5.  **Automated Email Ingestion:** An IMAP email inbox poller that automatically fetches emails, extracts PDF invoice attachments, and adds them to the processing queue. This includes parsing the email body text for additional context.
6.  **10it Data Export:** Generation of a CSV export file containing aggregated booking data formatted for the 10it accounting software.
7.  **Unified UI:** A multi-tab interface within the FIBU module to manage all the above features, including manual overrides for invoice-creditor matching.
</product_requirements>

<key_technical_concepts>
- **Frontend:** React ('use client'), Next.js, Tailwind CSS, shadcn/ui.
- **Backend:** Next.js API Routes (TypeScript), Node.js.
- **Databases:**
    - **MongoDB:** For application data (Kontenplan, EK-Rechnungen, Kreditoren, Email-Inbox).
    - **MS SQL:** For querying the external JTL ERP database.
- **AI Integration:** Google Gemini () for PDF and text parsing.
- **Integrations:**  &  for email polling,  for Excel,  for PDF reading.
- **Key Patterns:** Server-side pagination, cron job for automation, robust error handling for external services (SQL, IMAP).
</key_technical_concepts>

<code_architecture>
The application is a full-stack Next.js project. The majority of the work is encapsulated within the FIBU module, which consists of frontend components and a set of dedicated backend API routes.

**Directory Structure:**


**Key Files:**

-   ****
    -   **Importance:** The central, monolithic frontend component for the entire accounting module.
    -   **Summary:** This large client component manages the state and UI for all FIBU features. It contains a tabbed interface for Kontenplan, VK-Rechnungen (Sales Invoices), EK-Rechnungen (Supplier Invoices), Zahlungen (Payments), Kreditoren (Creditors), Export, and Email Inbox. It handles data fetching, user interactions like uploads and filtering, and displays data in tables. It was heavily modified to add a multi-file upload modal with manual creditor selection and to display information from the email inbox.

-   ****
    -   **Importance:** API to fetch sales invoices from the JTL MS SQL database.
    -   **Summary:** After significant debugging of SQL queries (errors like Invalid column name), the final implementation primarily uses the  view to reliably fetch invoice data. It was later modified to use a fallback for the customer name () to resolve an issue where it always showed the user's own company.

-   ****
    -   **Importance:** API to fetch payment transactions from JTL.
    -   **Summary:** This file also underwent extensive debugging to find the correct table () and columns. The query was simplified to fetch core payment details like provider, amount, and date, which are displayed in the Zahlungen tab. The current implementation is being re-evaluated due to missing data.

-   ****
    -   **Importance:** Handles the upload and processing of supplier invoices (PDFs).
    -   **Summary:** It uses  for file handling,  to extract text, calls the Gemini service () for data extraction, and then uses the  logic to find the best matching creditor. It was updated to handle special Amazon invoice number formats.

-   ****
    -   **Importance:** Manages the email inbox polling and processing.
    -   **Summary:** A new endpoint that connects to an IMAP server using credentials from . It can be triggered to fetch new emails, save them to MongoDB, and extract PDF attachments. It was made more robust to prevent data loss by processing both seen and unseen emails and using a  to prevent duplicates.

-   ****
    -   **Importance:** Encapsulates the IMAP connection and email parsing logic.
    -   **Summary:** Contains the core functions for connecting to the IMAP server, searching for emails, parsing them with , and handling attachments. It was updated to include the email's text body in the data sent for AI processing.

-   ****
    -   **Importance:** Houses the logic for matching suppliers to invoices.
    -   **Summary:** Provides a  function that uses both exact and fuzzy string matching () to find the correct creditor from the database based on text extracted from an invoice.

-   ****
    -   **Importance:** A one-time script to populate the creditors collection.
    -   **Summary:** Created to parse the user-provided  and import all creditors into the MongoDB database.
</code_architecture>

<pending_tasks>
- **Automatic Payment Matching for EK:** Automatically associate outgoing payments (Zahlungsabg√§nge) with the corresponding supplier invoices (EK-Rechnungen).
- **UI Filters:** Implement the frontend logic for the newly added payment filters (provider, assigned status).
- **10it Export Enhancement:** Integrate the fetched sales payment data into the final 10it export file, ensuring correct mapping between payments and invoices.
</pending_tasks>

<current_work>
The engineer is currently addressing several critical data integrity and completeness issues reported by the user, which are preventing the system from being fully production-ready.

1.  **Incorrect Payment Association:** The user has pointed out that many payments appearing as unassigned in the Zahlungen tab are, in fact, correctly assigned to invoices within the JTL system. The current SQL query in  is failing to retrieve this association.

2.  **Missing Transaction Data:** Commerzbank payment transactions, which are present in JTL for the selected date range (e.g., October 30th), are not being fetched and displayed in the application. This points to a flaw in the payment query's ability to capture all payment types.

3.  **Incomplete Data History:** The user has requested to load all historical transaction data up to the current day, rather than the limited date range currently hardcoded for testing. This requires parameterizing the API endpoints to accept a dynamic date range from the frontend.

The immediate task is to debug the SQL queries, primarily in , to ensure all payment types and their invoice associations are correctly and completely fetched from the JTL database.
</current_work>

<optional_next_step>
Address the data discrepancy issues by investigating why JTL-assigned payments are not correctly reflected and why Commerzbank transactions are missing. This involves debugging the SQL query in .
</optional_next_step>
