<analysis>
The trajectory documents the development of a sophisticated accounting (FIBU) module, starting from code review and moving to significant feature implementation and critical bug fixing. The initial phase focused on understanding the user's request for a Lexoffice-style system and implementing creditor assignment and data export functionalities.

A major challenge emerged with a slow, monolithic API endpoint, which was noted for future optimization. The project's focus then shifted to data quality. This led to the discovery of a critical bug where the Gemini AI parser incorrectly identified the user's own company as the supplier on 99 invoices. A complex but successful recovery operation was executed: the AI engineer improved the parser's prompt, deleted the faulty data, and orchestrated a complete re-parsing of the original 99 PDFs from their Base64 storage, successfully correcting the supplier information.

Following this critical fix, the engineer undertook a major UI/UX overhaul based on user feedback. This involved fixing a catastrophic mistake where a data-rich MongoDB API was almost replaced by a basic SQL query, resolving persistent browser caching issues that hid new features, and refactoring the main application navigation.

The final development phase involved implementing complex business logic for assigning debtor accounts based on payment types and tax status (IGL rules), which was successfully applied to the dataset. The last user request was to prepare the project for a fork by creating comprehensive documentation.
</analysis>

<product_requirements>
The primary goal is to build a comprehensive, in-house accounting (FIBU) module that mimics the functionality of professional software like Lexoffice. This system must centralize and automate financial bookkeeping.

**Core Features Implemented:**
1.  **Automated Invoice Parsing:** A hybrid system processes supplier invoices (EK-Rechnungen). It uses Python scripts for known suppliers and a Gemini AI-powered parser (via ) as a fallback for unknown ones. This system underwent a critical fix to prevent the AI from misidentifying the user's own company as the supplier.
2.  **Unified Dashboard:** A central dashboard () was created to provide an overview of all accounting items. It uses a tabbed interface to display:
    *   An overview of open items.
    *   A complete list of Sales Invoices (VK-Rechnungen) from both JTL (database) and external sources (e.g., Amazon), with filtering and search capabilities.
    *   Supplier Invoices (EK-Rechnungen) with tools for bulk creditor assignment.
    *   A Chart of Accounts ().
    *   A Bank Import utility for Postbank CSVs.
3.  **Debtor Account Logic:** A sophisticated rule-based system for assigning debtor accounts was implemented. It uses collective accounts () based on payment method but assigns unique debtor numbers to intra-community European (IGL) customers requiring a VAT ID.
4.  **Data Export:** An API endpoint was developed to export accounting data in a specific format required for a system named Tennet.
</product_requirements>

<key_technical_concepts>
- **Hybrid Invoice Parsing:** A two-tier strategy using rule-based Python scripts for predictable invoices and a Gemini AI parser as a fallback for unknown formats.
- **Python-Node.js Bridge:**  in Node.js is used to execute Python parsing scripts, passing PDF data via  and receiving structured JSON via .
- ** Library:** The crucial Python library enabling Gemini API access with the . The prompt was refined to prevent misidentification of the supplier.
- **Debtor Assignment Rules (Sammelkonten):** Business logic implemented via scripts to assign debtor accounts based on customer type (IGL vs. domestic) and payment method.
</key_technical_concepts>

<code_architecture>
The application is a Next.js full-stack SPA using hash-based routing managed within . The backend consists of API routes, while the frontend is built with React and shadcn/ui. A key architectural feature is the integration of Python scripts for specialized tasks.

**Directory Structure:**


**Key File Analysis:**

-   ****
    -   **Importance:** Core of the AI parsing. Takes a Base64 PDF and returns JSON.
    -   **Summary of Changes:** A critical prompt update was made:  This fixed a bug where 99 invoices were parsed with the wrong supplier.

-   **ğŸ” Suche PDFs ohne zugehÃ¶rige EK-Rechnung...

ğŸ“§ 190 processed Emails gefunden
ğŸ”„ 0 PDFs mÃ¼ssen neu verarbeitet werden

âœ… Alle PDFs haben bereits EK-Rechnungen!**
    -   **Importance:** A one-off recovery script created to fix the critical parsing bug.
    -   **Summary of Changes:** Created from scratch. It finds processed PDFs (stored as  in the  collection) that correspond to the 99 deleted incorrect invoices and re-runs them through the now-fixed , saving the corrected data.

-   ****
    -   **Importance:** API endpoint for fetching Sales Invoices (VK-Rechnungen).
    -   **Summary of Changes:** This file was the subject of a near-disastrous mistake. It was incorrectly modified to pull minimal data from the JTL SQL database, losing all enriched data. It was successfully reverted to load the complete, correct data from the  collection in MongoDB, preserving all assignments.

-   ****
    -   **Importance:** A brand-new component for displaying all sales invoices (JTL + external).
    -   **Summary of Changes:** Created to replace a basic table. It includes advanced features like filtering by status and source, a search bar, correct date formatting, and a dark-mode-friendly UI with legible text, resolving multiple user complaints.

-   **================================================================================
ğŸ”„ DEBITOR-REGELN ANWENDEN
================================================================================

ğŸ“‹ 20 Sammelkonten geladen
ğŸ“‹ IGL-Regel: âœ…

ğŸ“„ 1129 VK-Rechnungen zu prÃ¼fen

ğŸ”„ Starte Zuordnung...

================================================================================
âœ… FERTIG!
================================================================================

âœ… 29 IGL-Kunden â†’ Eigene Debitoren (10xxx)
âœ… 1100 Kunden â†’ Sammelkonten (69xxx)
âŒ 0 Fehler

ğŸ“Š IGL-DEBITOREN (mit USt-ID):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  10000: Kunde #241198 (DE) - USt-ID: DE815541191

================================================================================**
    -   **Importance:** Encapsulates critical business logic for assigning debtor accounts.
    -   **Summary of Changes:** Created to implement the  logic. The script iterates through customers, assigning unique debtor numbers (10xxx range) to IGL customers and collective account numbers (69xxx range) to others based on their payment method.

-   ****
    -   **Importance:** The main single-page application entry point that controls navigation via hash changes.
    -   **Summary of Changes:** The navigation structure was heavily refactored. The FIBU menu item was correctly pointed to the new , and the Outbound section was consolidated from separate menu items into a single dropdown menu.
</code_architecture>

<pending_tasks>
- **Import Postbank Data:** The  component and its API exist, but no Postbank CSV data has been imported and processed yet. This is a major gap in the accounting overview.
- **Performance Optimization:** The  API endpoint is critically slow (5-15 seconds) because it makes multiple internal API calls. It needs to be refactored to query data sources directly for better performance.
- **Fix Pferd Parser:** The Python parser for August RÃ¼ggeberg (Pferd) invoices was noted as causing errors early on but was never fixed.
</pending_tasks>

<current_work>
The most recent work was a direct response to the user's request: **Ready machen zum forken bitt etxt datein fÃ¼llen** (Get it ready to fork, please fill out the text files). The previous AI engineer acknowledged this and was about to begin creating and populating all necessary documentation files to prepare the project for a handover or fork.

This documentation task was initiated immediately after a series of significant and successful development cycles, which included:
1.  **Critical Bug Fix:** Finding and resolving the Gemini parser issue that incorrectly assigned Score Schleifwerkzeuge as a supplier for 99 invoices, followed by a full re-parsing of the affected documents.
2.  **UI/UX Overhaul:** A complete redesign of the Sales Invoice view () to include filtering, searching, correct data display, and fixing all cosmetic issues reported by the user (e.g., text color, date format).
3.  **Navigation Refactoring:** Reorganizing the main application's navigation to place the new FIBU dashboard correctly and consolidate the Outbound menu into a dropdown.
4.  **Business Logic Implementation:** Successfully scripting and applying the complex  rules for debtor account assignment.

Therefore, the project state is feature complete for the last set of user requests, with the final action being the start of the documentation process.
</current_work>

<optional_next_step>
Create and populate the documentation files (, , , etc.) in the  directory as requested by the user to prepare the project for the fork.
